version: '3.8'

networks:
  loki:

services:
  graphite:
    container_name: graphite
    image: graphiteapp/graphite-statsd:1.1.8-1
    volumes:
      - ./graphite/storage:/opt/graphite/storage
      - ./graphite/conf:/opt/graphite/conf
      - ./graphite/statsd:/opt/statsd/config
      - ./graphite/log:/var/log
    ports:
      - 7000:80
      - 2003-2004:2003-2004
      - 2023-2024:2023-2024
      - 8125:8125/udp
      - 8126:8126  
    restart: always
    environment:
      - TZ=Europe/London
    logging:
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}" 

  loki:
    image: grafana/loki:2.3.0
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/loki-config.yml
    networks:
      - loki
    volumes:
      - ./loki/conf:/etc/loki
      - loki-storage:/loki
    logging:
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"

  promtail:
    image: grafana/promtail:2.3.0
    ports:
      - "1514:1514/tcp"
      - "1514:1514/udp"
      - "9080:9080"
    volumes:
      - ./promtail/log:/var/log
      - ./promtail/conf:/etc/promtail
      - /var/lib/docker/containers:/host/var/lib/docker/containers
      - /var/log/nginx:/host/var/log/nginx
      - /var/log/php-fpm:/host/var/log/php-fpm
      - /var/log/mariadb:/host/var/log/mariadb
      - /var/log/journal:/host/var/log/journal
      - /etc/machine-id:/etc/machine-id
    command: -config.file=/etc/promtail/config.yml
    networks:
      - loki
    logging:
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"

  grafana:
    image: grafana/grafana:8.1.6
    container_name: grafana
    restart: always
    volumes:
      - grafana-storage:/var/lib/grafana
    ports:
      - 3000:3000
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_DOMAIN=grafana.parois.net
      - GF_SMTP_ENABLED=true
    networks:
      - loki
    logging:
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"

volumes:
  grafana-storage:
    name: grafana-storage
    external: true
  loki-storage:
    name: loki-storage
    external: true
